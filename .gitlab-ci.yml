stages:
    - lint
    - build
    - test
    - publish
    - deploy

lint:
    stage: lint
    image: python:3.13-alpine
    before_script:
        - pip3 install -r requirements-lint.txt
    script:
        - black --line-length 120 --check . >> lint.txt
    allow_failure: true

build:
    stage: build
    image: docker:latest
    services:
        - docker:dind
    only:
        - proximo
        - teste
        - producao
    before_script:
        - echo "Building the code..."
        - echo "APP_VERSION = '$CI_PIPELINE_ID.$CI_COMMIT_SHORT_SHA'" >> src/settings/apps.py
        - cat src/settings/apps.py
    script:
        - docker build --build-arg EXTRA_REQ="" -t ctezlifrn/avaintegrador:$CI_COMMIT_REF_NAME .
    after_script:
        - echo "Build complete."

# unit-test-job:
#     stage: test
#     script:
#         - chmod -R 777 .
#         - docker run --rm --user 1001:1001 -e DJANGO_DEBUG=false -v ./src/:/apps/app ctezlifrn/avaintegrador:$CI_COMMIT_REF_NAME coverage run manage.py test
#         - docker run --rm --user 1001:1001 -e DJANGO_DEBUG=false -v ./src/:/apps/app ctezlifrn/avaintegrador:$CI_COMMIT_REF_NAME coverage xml
#         - docker run --rm --user 1001:1001 -e DJANGO_DEBUG=false -v ./src/:/apps/app ctezlifrn/avaintegrador:$CI_COMMIT_REF_NAME coverage report
#     artifacts:
#         # https://docs.gitlab.com/ee/ci/yaml/index.html#artifactsexpire_in
#         expire_in: 1 year

#         # https://docs.gitlab.com/ee/ci/testing/test_coverage_visualization.html
#         reports:
#             coverage_report:
#                 coverage_format: cobertura
#                 path: src/coverage.xml

publish:
    stage: publish
    only:
        - proximo
        - teste
        - producao
    script:
        - docker login -u $DOCKERHUB_REGISTRY_USER -p $DOCKERHUB_REGISTRY_PASSWORD
        - docker push ctezlifrn/avaintegrador:$CI_COMMIT_REF_NAME

deploy-teste:
    stage: deploy
    only:
        - teste
    before_script:
        - echo "Deploying service in test..."
        - mkdir -p ~/.ssh
        - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
        - chmod 700 ~/.ssh/id_rsa
    script:
        - ssh -o StrictHostKeyChecking=no root@$TEST_HOST "/var/dockers/vai deploy app"
        - sleep 60
        - ssh -o StrictHostKeyChecking=no root@$TEST_HOST "/var/dockers/vai logs -n 1000"
        - echo "Service successfully deployed in test."

deploy-producao:
    stage: deploy
    only:
        - producao
    before_script:
        - echo "Deploying service in test..."
        - mkdir -p ~/.ssh
        - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
        - chmod 700 ~/.ssh/id_rsa
    script:
        - ssh -o StrictHostKeyChecking=no root@PROD_HOST "/var/dockers/vai deploy app"
        - sleep 60
        - ssh -o StrictHostKeyChecking=no root@PROD_HOST "/var/dockers/vai logs -n 1000"
        - echo "Service successfully deployed in test."
